# Real Token Usage Tracking for Claude Code Statusline

## Overview
Claude Code exposes actual token usage metrics through OpenTelemetry (OTLP). This feature allows the statusline to display real token consumption instead of estimates.

## How It Works

1. **Claude Code Telemetry**: When enabled, Claude Code sends metrics including `claude_code.token.usage` to an OTLP endpoint
2. **Token Metrics Proxy**: Captures these metrics and saves them to `~/.claude/token-metrics.json`
3. **Statusline Integration**: The statusline checks for fresh metrics and displays them with a ðŸ“Š indicator

## Quick Start

### Option 1: Use the Launch Script (Recommended)
```bash
./launch-claude-with-metrics.sh
```
This script:
- Starts the token metrics proxy in the background
- Launches Claude Code with telemetry enabled
- Cleans up when Claude Code exits

### Option 2: Manual Setup
1. Start the metrics proxy:
```bash
python3 token-metrics-proxy.py &
```

2. Launch Claude Code with telemetry:
```bash
export CLAUDE_CODE_ENABLE_TELEMETRY=1
export OTEL_METRICS_EXPORTER=otlp
export OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4318
export OTEL_METRIC_EXPORT_INTERVAL=5000
claude
```

## What You'll See

### With Real Metrics
```
ðŸ¤– Opus 4.1 | ðŸ’° $0.15 session / $0.35 today | ðŸ“Š 54,231 tokens (actual) | ðŸ”¥ 850 tok/min
```
Note the ðŸ“Š icon and "(actual)" label indicating real token usage.

### Without Real Metrics (Fallback)
```
ðŸ¤– Opus 4.1 | ðŸ’° $0.15 session / $0.35 today | 52,100 tokens | ðŸ”¥ 850 tok/min
```
Falls back to ccusage estimates when real metrics aren't available.

## Metric Types Tracked

- **input**: Tokens sent to the model
- **output**: Tokens generated by the model
- **cacheRead**: Tokens read from cache
- **cacheCreation**: Tokens used to create cache

## Files Created

- `~/.claude/token-metrics.json`: Latest token usage data
- Updated automatically every 5 seconds (configurable via OTEL_METRIC_EXPORT_INTERVAL)

## Troubleshooting

### Metrics Not Appearing
1. Ensure the proxy is running: `ps aux | grep token-metrics-proxy`
2. Check Claude Code has telemetry enabled: Environment variables must be set BEFORE launching
3. Verify port 4318 is available: `lsof -i :4318`

### Stale Metrics
- Metrics older than 60 seconds are ignored
- Check timestamp in `~/.claude/token-metrics.json`

## Technical Details

- Uses OpenTelemetry Protocol (OTLP) HTTP endpoint on port 4318
- Metrics are cumulative for the session
- Proxy handles metric aggregation and persistence
- Statusline reads metrics file with freshness check

## Limitations

- Requires restarting Claude Code with telemetry enabled
- Cannot capture metrics from already-running Claude Code instances
- Metrics are session-specific (reset when Claude Code restarts)