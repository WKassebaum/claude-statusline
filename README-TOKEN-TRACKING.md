# Real Token Usage Tracking for Claude Code Statusline

## ⚠️ CRITICAL SAFETY WARNING

**Token tracking can crash Claude Code if misconfigured!**

**Before enabling:**
1. ✅ **Follow the testing protocol**: See `TESTING-PROTOCOL.md`
2. ✅ **Test in isolation**: Never enable in your main working environment first
3. ✅ **Have recovery plan**: Know how to disable quickly if issues occur

**Known issues that cause crashes:**
- Missing `OTEL_EXPORTER_OTLP_PROTOCOL=http/json` (critical!)
- Malformed OTLP endpoint configuration
- Environment variable pollution between sessions

## Overview
Claude Code exposes actual token usage metrics through OpenTelemetry (OTLP). This feature allows the statusline to display real token consumption instead of estimates.

**🚨 This feature is experimental and requires careful testing before production use.**

## How It Works

1. **Claude Code Telemetry**: When enabled, Claude Code sends metrics including `claude_code.token.usage` to an OTLP endpoint
2. **Token Metrics Proxy**: Captures these metrics and saves them to `~/.claude/token-metrics.json`
3. **Statusline Integration**: The statusline checks for fresh metrics and displays them with a 📊 indicator

## Quick Start

### ⚠️ REQUIRED: Follow Testing Protocol First
**Do NOT skip this step:**
```bash
# 1. Read the testing protocol
cat TESTING-PROTOCOL.md

# 2. Run safety checks
./claude-token-safe-test.sh

# 3. Follow the step-by-step testing process
```

### Option 1: Safe Configuration Approach (Recommended)
Use the safer configuration script instead of direct .zshrc modification:
```bash
# Add to your .zshrc:
export CLAUDE_TOKEN_TRACKING=1  # or 0 to disable
source "$HOME/WorkDev/MCP-Dev/claude-statusline/claude-token-config.sh"
```

### Option 2: Manual Testing (For Troubleshooting)
```bash
# In an isolated test terminal:
export CLAUDE_TOKEN_TRACKING=1
source ./claude-token-config.sh
claude --version  # Test basic functionality
```

### Emergency Disable
If Claude Code crashes or behaves strangely:
```bash
export CLAUDE_TOKEN_TRACKING=0
unset CLAUDE_CODE_ENABLE_TELEMETRY OTEL_METRICS_EXPORTER OTEL_EXPORTER_OTLP_ENDPOINT OTEL_EXPORTER_OTLP_PROTOCOL OTEL_METRIC_EXPORT_INTERVAL
```

### Option 2: Use the Launch Script
```bash
./launch-claude-with-metrics.sh
```
This script:
- Starts the token metrics proxy in the background
- Launches Claude Code with telemetry enabled
- Cleans up when Claude Code exits

### Option 3: Manual Setup
1. Start the metrics proxy:
```bash
./start-token-proxy.sh
# or manually: python3 token-metrics-proxy.py &
```

2. Launch Claude Code (with env vars already set via .zshrc):
```bash
claude
```

## Helper Scripts

- **`start-token-proxy.sh`**: Starts the proxy if not already running
- **`stop-token-proxy.sh`**: Stops the proxy cleanly
- **`launch-claude-with-metrics.sh`**: All-in-one launcher

## What You'll See

### With Real Metrics
```
🤖 Opus 4.1 | 💰 $0.15 session / $0.35 today | 📊 54,231 tokens (actual) | 🔥 850 tok/min
```
Note the 📊 icon and "(actual)" label indicating real token usage.

### Without Real Metrics (Fallback)
```
🤖 Opus 4.1 | 💰 $0.15 session / $0.35 today | 52,100 tokens | 🔥 850 tok/min
```
Falls back to ccusage estimates when real metrics aren't available.

## Metric Types Tracked

- **input**: Tokens sent to the model
- **output**: Tokens generated by the model
- **cacheRead**: Tokens read from cache
- **cacheCreation**: Tokens used to create cache

## Files Created

- `~/.claude/token-metrics.json`: Latest token usage data
- Updated automatically every 5 seconds (configurable via OTEL_METRIC_EXPORT_INTERVAL)

## Troubleshooting

### Metrics Not Appearing
1. Ensure the proxy is running: `ps aux | grep token-metrics-proxy`
2. Check Claude Code has telemetry enabled: Environment variables must be set BEFORE launching
3. Verify port 4318 is available: `lsof -i :4318`

### Stale Metrics
- Metrics older than 60 seconds are ignored
- Check timestamp in `~/.claude/token-metrics.json`

## Technical Details

- Uses OpenTelemetry Protocol (OTLP) HTTP endpoint on port 4318
- Metrics are cumulative for the session
- Proxy handles metric aggregation and persistence
- Statusline reads metrics file with freshness check

## Setup for .zshrc Auto-Start

Add this to your `.zshrc` for fully automatic token tracking:

```bash
## Claude Code Token Tracking (OpenTelemetry)
export CLAUDE_TOKEN_TRACKING=1
if [[ "$CLAUDE_TOKEN_TRACKING" == "1" ]]; then
  export CLAUDE_CODE_ENABLE_TELEMETRY=1
  export OTEL_METRICS_EXPORTER=otlp
  export OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4318
  export OTEL_METRIC_EXPORT_INTERVAL=5000
  
  # Auto-start token proxy if not running (silent check)
  if ! lsof -i :4318 >/dev/null 2>&1; then
    if [ -f "$HOME/WorkDev/MCP-Dev/claude-statusline/start-token-proxy.sh" ]; then
      ($HOME/WorkDev/MCP-Dev/claude-statusline/start-token-proxy.sh >/dev/null 2>&1 &)
    fi
  fi
fi
```

## Limitations

- Requires restarting Claude Code with telemetry enabled
- Cannot capture metrics from already-running Claude Code instances
- Metrics are session-specific (reset when Claude Code restarts)